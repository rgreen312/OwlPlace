FROM golang:1.13.1-alpine3.10 AS rocksbuilder

RUN echo "@testing http://nl.alpinelinux.org/alpine/edge/testing" >>/etc/apk/repositories
RUN apk add --update --no-cache build-base linux-headers git cmake bash #wget mercurial g++ autoconf libgflags-dev cmake  bash jemalloc
RUN apk add --update --no-cache \
    zlib \
    zlib-dev \
    bzip2 \
    bzip2-dev \
    snappy \
    snappy-dev \
    lz4 \
    lz4-dev \
    zstd@testing \
    zstd-dev@testing \
    libtbb-dev@testing \
    libtbb@testing

# gflags from source
ENV GFLAGS_VERSION 2.0
RUN cd /tmp &&\
    git clone -b v${GFLAGS_VERSION} --single-branch https://github.com/gflags/gflags.git &&\
    cd gflags &&\
    ./configure --prefix=/usr && make && make install &&\
    rm -rf /tmp/*

# Install Rocksdb
RUN cd /tmp && \
    git clone -b v6.3.6 --single-branch https://github.com/facebook/rocksdb.git && \
    cd rocksdb && \
    make shared_lib && \
    mkdir -p /usr/local/rocksdb/lib && \
    mkdir /usr/local/rocksdb/include && \
    cp librocksdb.so* /usr/local/rocksdb/lib && \
    cp /usr/local/rocksdb/lib/librocksdb.so* /usr/lib/ && \
    cp -r include /usr/local/rocksdb/ && \
    cp -r include/* /usr/include/ && \
    rm -R /tmp/rocksdb/

FROM golang:1.13.1-alpine3.10 AS serverbuilder

COPY --from=rocksbuilder /usr/lib/libgflags* /usr/lib/
COPY --from=rocksbuilder /usr/include/gflags /usr/include/gflags
COPY --from=rocksbuilder /usr/include/google /usr/include/google
COPY --from=rocksbuilder /usr/local/rocksdb /usr/local/rocksdb
COPY --from=rocksbuilder /usr/lib/librocksdb.so* /usr/lib/
COPY --from=rocksbuilder /usr/local/rocksdb/include/rocksdb /usr/include/rocksdb

RUN echo "@testing http://nl.alpinelinux.org/alpine/edge/testing" >>/etc/apk/repositories
RUN apk add --update --no-cache \
        ca-certificates \
        build-base \
        linux-headers
RUN apk add --update --no-cache \
        zlib \
        zlib-dev \
        bzip2 \
        bzip2-dev \
        snappy \
        snappy-dev \
        lz4 \
        lz4-dev \
        zstd@testing \
        zstd-dev@testing \
        libtbb-dev@testing \
        libtbb@testing

COPY server /app

RUN cd /app && go build 

FROM alpine:3.10 AS server

RUN echo "@testing http://nl.alpinelinux.org/alpine/edge/testing" >>/etc/apk/repositories
RUN apk add --update --no-cache \
        ca-certificates
RUN apk add --update --no-cache \
        zlib \
        zlib-dev \
        bzip2 \
        bzip2-dev \
        snappy \
        snappy-dev \
        lz4 \
        lz4-dev \
        zstd@testing \
        zstd-dev@testing \
        libtbb-dev@testing \
        libtbb@testing

COPY --from=rocksbuilder /usr/lib/libgflags* /usr/lib/
COPY --from=rocksbuilder /usr/include/gflags /usr/include/gflags
COPY --from=rocksbuilder /usr/include/google /usr/include/google
COPY --from=rocksbuilder /usr/local/rocksdb /usr/local/rocksdb
COPY --from=rocksbuilder /usr/lib/librocksdb.so* /usr/lib/
COPY --from=rocksbuilder /usr/local/rocksdb/include/rocksdb /usr/include/rocksdb
COPY --from=serverbuilder /app/server /bin/server

ENV NODEID 0
ENV CONFIG /usr/share/owlplace.json
CMD "/bin/server" "-nodeid" "$NODEID" "-config" "$CONFIG"
